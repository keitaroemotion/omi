<html>
<title> Omise.js usage sample </title>

<head>
    <font face = "Verdana" size = "5">Please Enter your Credit Card Information below:</font>
</head>

<!-- 
    This file is for demonstrating the embedding of Omise.js module.
    For more details: https://www.omise.co/collecting-card-information
>

<!-- 
    Omise.js does the following:
  
    1. User enters his/her sensitive credit card data
       via the client browser(Omise.js embedded in it).
  
    2. Omise.js encrypts sends the data(1.) into a token. [with merchant's public key?]
  
    3. token(T) is sent to Omise Server.
       (it is saved in the sensitive DB on the server which PCI-DSS compliant)
  
    4. token(T) is forwarded back to merchant's server(M).
       (yet it is not good practice to store that token to M sinc if it is compromised,
        can cause the severe security bleech)
  
    5. with T, you can do the following:
      - charge the card
      - save the card on a new customer
      - attach a card to the existing customer
-->
<script src="https://cdn.omise.co/omise.js"></script>


<!-- jquery usage is not mandatory -->
<script src="http://code.jquery.com/jquery-1.12.1.min.js"></script>

<!--

    Set merchant's public key here: 
    
    As Convention, our keys are defined as follows:

    Public Key: /^pkey_.+/
    Secret Key: /^skey_.+/

    When Secret Key has been compromised, your business is exposed at risk
    So please keep it secret always and never expose it anywhere.

-->
<script>
    Omise.setPublicKey("pkey_test_4xpip92iqmehclz4a4d");
</script>


<!--

    Form for customers to submit their credit card data

    This example has presets of fake credit card data such as:

    Name:   Vitalik Buterin
    Number: 4343434343434343 
    Date:   02/2019
    CVV:    636

-->
<body>
    <br><br>
    <form action="./checkout.html" method="post" id="checkout">
        <div id="token_errors"/>
        <input type="hidden" name="omise_token">

        <font face = "Verdana" size = "3">
            <div>Name<br><input type="text" value="Vitalik Buterin" data-omise="holder_name"></div><br>
            <div>Number<br><input type="text" value="4343434343434343" data-omise="number"></div><br>
            <div>Date<br>
                <input type="text" data-omise="expiration_month" value="02" size="4"> /
                <input type="text" data-omise="expiration_year" value="2019" size="8">
            </div><br>
            <div>Security Code<br>
                <input type="text" data-omise="security_code" value="636" size="8">
            </div>
            <!-- Submit Button(S) -->
            <input type="submit" id="create_token">
        </font>    
    </form>
</body>    

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js">
    /**
     *
     *  Trigger the creation of the token(T) when the submit button(S) is pressed.
     *  Then fill the token field and clear the other fields so they are
     *  not submitted to your server.
     *
     */
    $("#checkout").submit(function () {

      var form = $(this);

      // Disable the submit button to avoid repeated click.
      form.find("input[type=submit]").prop("disabled", true);

      // Serialize the form fields into a valid card object.
      var card = {
          "name":             form.find("[data-omise=holder_name]").val(),
          "number":           form.find("[data-omise=number]").val(),
          "expiration_month": form.find("[data-omise=expiration_month]").val(),
          "expiration_year":  form.find("[data-omise=expiration_year]").val(),
          "security_code":    form.find("[data-omise=security_code]").val()
      };

      /**
       *
       *   1. Send a request to create a token(T)
       *   2. Trigger the callback function once a response is received from Omise.
       *  
       *   Note that the response could be an error
       *   and this needs to be handled within the callback.
       *
       **/
      Omise.createToken("card", card, function (statusCode, response) {
        if (response.object == "error" || !response.card.security_code_check) {
          // Display an error message.
          var message_text = "SET YOUR SECURITY CODE CHECK FAILED MESSAGE";
          if(response.object == "error") {
            message_text = response.message;
          }
          $("#token_errors").html(message_text);

          // Re-enable the submit button.
          form.find("input[type=submit]").prop("disabled", false);
        } else {
          // Then fill the omise_token.
          form.find("[name=omise_token]").val(response.id);

          // Remove card number from form before submiting to server.
          form.find("[data-omise=number]").val("");
          form.find("[data-omise=security_code]").val("");

          // submit token to server.
          form.get(0).submit();
        };
      });

      // Prevent the form from being submitted;
      return false;
    });
</script>

</html>
